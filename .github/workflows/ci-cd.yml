name: CI/CD - Publish Package

on:
  pull_request:
    branches:
      - main  # Trigger on PR creation or updates targeting main
  push:
    branches:
      - main  # Trigger on push to main (for merge events)

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v2

      # Set up Python (adjust version as needed)
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      # Install Poetry using the official installer
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          poetry --version  # Verify Poetry is installed

      # Install dependencies, including dev dependencies
      - name: Install dependencies
        run: |
          poetry install --with dev

      # Run tests to ensure the code is valid
      - name: Run tests
        run: |
          poetry run pytest --maxfail=1 --disable-warnings -q

      # If tests pass, generate a temporary version and publish for PRs
      - name: Generate and publish temporary version for PR
        if: success()
        run: |
          # Get the current version or fallback
          VERSION=$(poetry version --short || echo "0.1.0")
          echo "Detected Poetry version: $VERSION"

          # Set a temporary version for the PR (e.g., 0.1.0-pr123)
          NEW_VERSION="${VERSION}-pr${{ github.event.pull_request.number || github.run_number }}"
          echo "Setting temporary version: ${NEW_VERSION}"

          # Set version with Poetry
          poetry version "$NEW_VERSION"

          # Configure token and publish to GitHub Packages
          poetry config pypi-token.pypi "${{ secrets.GH_TOKEN }}"
          poetry publish --build --no-interaction --repository github

      # On PR merge, delete the temporary version and publish the stable version
      - name: Handle PR merge - Delete temp version and publish stable version
        if: github.event.pull_request.merged == true && success()
        run: |
          echo "Deleting temporary version from GitHub Packages"
          TEMP_VERSION="${VERSION}-pr${{ github.event.pull_request.number || github.run_number }}"
          PACKAGE_NAME="zenofcode-models"

          # Delete temporary package version via GitHub API
          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/packages/container/$PACKAGE_NAME/versions/$TEMP_VERSION"

          echo "Releasing stable version"
          # Get current stable version and publish
          STABLE_VERSION=$(poetry version --short)
          poetry version "$STABLE_VERSION"
          poetry publish --build --no-interaction --repository github

      # Create a GitHub Release with the stable version
      - name: Create GitHub Release
        if: github.event.pull_request.merged == true && success()
        run: |
          echo "Creating GitHub Release"
          TAG_NAME="v$(poetry version --short)"
          GITHUB_TOKEN="${{ secrets.GH_TOKEN }}"

          # Create release using GitHub API
          curl -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"tag_name": "'$TAG_NAME'", "target_commitish": "main", "name": "Release '$TAG_NAME'", "body": "Release for version '$TAG_NAME'", "draft": false, "prerelease": false}' \
            "https://api.github.com/repos/${{ github.repository }}/releases"
