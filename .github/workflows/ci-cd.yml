name: CI/CD - Publish Package to GitHub Packages

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          poetry --version

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Configure Poetry for GitHub Packages
        run: |
          # Configure the repository URL for GitHub Packages for Python.
          poetry config repositories.github "https://upload.pypi.pkg.github.com/${{ github.repository_owner }}"
          # Set up HTTP Basic Auth using __token__ as the username and your GH_TOKEN as the password.
          poetry config http-basic.github __token__ "${{ secrets.GH_TOKEN }}"

      - name: Test connectivity to GitHub Packages endpoint (for debugging)
        run: |
          # Using -k to bypass SSL verification for testing purposes only.
          curl -k -I "https://upload.pypi.pkg.github.com/${{ github.repository_owner }}"

      - name: Generate and publish dynamic version for PR
        if: github.event_name == 'pull_request'
        run: |
          VERSION=$(poetry version --short || echo "0.1.0")
          echo "Current base version: $VERSION"
          NEW_VERSION="${VERSION}.dev${{ github.event.pull_request.number }}+${{ github.run_number }}"
          echo "Setting dynamic PR version: ${NEW_VERSION}"
          poetry version "$NEW_VERSION"
          poetry publish --build --repository github -vvv

      - name: Publish stable version on merge
        if: github.event.pull_request.merged == true
        run: |
          STABLE_VERSION=$(poetry version --short)
          echo "Releasing stable version: $STABLE_VERSION"
          poetry version "$STABLE_VERSION"
          poetry publish --build --repository github -vvv

      - name: Create GitHub Release
        if: github.event.pull_request.merged == true
        run: |
          TAG_NAME="v$(poetry version --short)"
          echo "Creating GitHub Release: $TAG_NAME"
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"tag_name": "'$TAG_NAME'", "target_commitish": "main", "name": "Release '$TAG_NAME'", "body": "Release for version '$TAG_NAME'", "draft": false, "prerelease": false}' \
            "https://api.github.com/repos/${{ github.repository }}/releases"
